events {
    worker_connections 1024;
}

http {
    # Rate Limiting 설정
    # $binary_remote_addr: 클라이언트 IP 기준
    # 10m: 약 16만 개 IP 저장 가능한 메모리
    # 10r/s: 초당 10 요청 제한
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    upstream gateway {
        server gateway:8000;
    }

    server {
        listen 80;

        location /api/ {
            # burst=20: 순간 20개 요청까지 허용 (큐에 대기)
            # nodelay: 큐 대기 없이 즉시 처리 (초과분만 거부)
            limit_req zone=api burst=20 nodelay;

            proxy_pass http://gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # SSE Streaming 지원 (LLM 응답용)
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 300s;  # LLM 응답 대기 최대 5분
        }

        location /health {
            proxy_pass http://gateway;
        }

        # Swagger UI 문서
        location /docs {
            proxy_pass http://gateway;
        }

        # OpenAPI Schema
        location /openapi.json {
            proxy_pass http://gateway;
        }
    }
}
